generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(uuid()) @db.Uuid
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          UserRole  @default(user)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]
  testRuns TestRun[]

  @@index([email])
}

model Account {
  userId            String  @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  sessionToken String   @unique
  userId       String   @db.Uuid
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model TestRun {
  id        String     @id @default(uuid()) @db.Uuid
  userId    String     @db.Uuid
  status    TestStatus @default(Queued)
  startedAt DateTime?
  endedAt   DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  testConfig         TestConfig?
  testMetrics        TestMetric[]
  testResult         TestResult?
  healthCheckSummary HealthCheckSummary?
  errorInfos         ErrorInfo[]

  @@index([userId, status])
  @@index([status, createdAt])
}

model TestMetric {
  id              String   @id @default(uuid()) @db.Uuid
  testRunId       String   @db.Uuid
  timetamp        DateTime @default(now())
  throughput      Float
  statusCode      Int
  vusersCreated   Int
  vusersActive    Int
  p95ResponseTime Float
  p99ResponseTime Float

  testRun TestRun @relation(fields: [testRunId], references: [id], onDelete: Cascade)

  @@index([testRunId, timetamp])
}

model TestConfig {
  id          String     @id @default(uuid()) @db.Uuid
  testRunId   String     @unique @db.Uuid
  name        String
  url         String
  method      HttpMethod @default(GET)
  region      String
  duration    Float
  rampUp      Float
  rampUpSteps Float
  vusers      Int
  concurrency Int // We don't need to track this anymore
  headers     Json?
  body        Json?
  createdAt   DateTime   @default(now())

  testRun TestRun @relation(fields: [testRunId], references: [id], onDelete: Cascade)

  @@index([testRunId])
}

model TestResult {
  id                 String   @id @default(uuid()) @db.Uuid
  testRunId          String   @unique @db.Uuid
  avgThroughput      Float
  maxThroughput      Float
  vusersCreated      Int
  minResponseTime    Float
  avgResponseTime    Float
  p50ResponseTime    Float
  p95ResponseTime    Float
  p99ResponseTime    Float
  maxResponseTime    Float
  successRate        Float
  errorRate          Float
  successfulRequests Int
  failedRequests     Int
  statusCodes        Json
  logs               Json?
  createdAt          DateTime @default(now())

  testRun TestRun @relation(fields: [testRunId], references: [id], onDelete: Cascade)

  @@index([testRunId])
}

model HealthCheckResult {
  id                   String   @id @default(uuid()) @db.Uuid
  healthCheckSummaryId String   @db.Uuid
  checkName            String
  threshold            Float
  actualValue          Float
  passed               Boolean
  failureDetails       Json?
  createdAt            DateTime @default(now())

  healthCheckSummary HealthCheckSummary? @relation(fields: [healthCheckSummaryId], references: [id], onDelete: Cascade)

  @@index([healthCheckSummaryId])
}

model ErrorInfo {
  id        String   @id @default(uuid()) @db.Uuid
  testRunId String   @db.Uuid
  errorType String
  errorCode String?
  message   String
  details   Json?
  timestamp DateTime @default(now())
  count     Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  testRun TestRun @relation(fields: [testRunId], references: [id], onDelete: Cascade)

  @@index([testRunId, errorType])
  @@index([testRunId, timestamp])
}

model HealthCheckSummary {
  id             String            @id @default(uuid()) @db.Uuid
  testRunId      String            @unique @db.Uuid
  totalChecks    Int
  passedChecks   Int
  failedChecks   Int
  passPercentage Float
  overallStatus  HealthCheckStatus
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  testRun            TestRun             @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  healthCheckResults HealthCheckResult[]

  @@index([testRunId])
}

enum UserRole {
  user
  admin
}

enum HttpMethod {
  GET
  POST
  PUT
  DELETE
}

enum TestStatus {
  Queued
  Running
  Succeeded
  Failed
  Canceled
  Timeout
}

enum HealthCheckStatus {
  PASS
  FAIL
  PARTIAL
}
