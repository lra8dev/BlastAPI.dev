# Development Dockerfile for Express server with hot reload
FROM node:22-alpine

# Install pnpm
RUN corepack enable && corepack prepare pnpm@10.15.0 --activate

# Install dependencies needed for native modules
RUN apk add --no-cache libc6-compat

WORKDIR /app

# Copy workspace config files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY tsconfig.base.json ./

# Copy all package.json files for workspace packages
COPY apps/server/package.json ./apps/server/
COPY packages/db/package.json ./packages/db/
COPY packages/utils/package.json ./packages/utils/
COPY packages/validators/package.json ./packages/validators/

# Install all dependencies (including devDependencies for hot reload)
RUN pnpm install --frozen-lockfile

# Copy source files
COPY . .

# Generate Prisma client
RUN pnpm --filter @blastapi/db db:generate

# Build shared packages (order matters: db -> utils -> validators)
RUN pnpm --filter @blastapi/db build
RUN pnpm --filter @blastapi/validators build
RUN pnpm --filter @blastapi/utils build

EXPOSE 4000

ENV PORT=4000
ENV NODE_ENV=development

# Start with tsx watch for hot reload
CMD ["pnpm", "--filter", "@blastapi/server", "dev"]
